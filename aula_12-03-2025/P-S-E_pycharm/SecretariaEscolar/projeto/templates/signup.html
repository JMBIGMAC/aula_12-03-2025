<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
</head>
<body>
    <h1>Cadastro de Usuário</h1>
    <form id="signup-form">
        <div>
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email">
        </div>
        <div>
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div>
            <label for="group">Grupo:</label>
            <select id="group" name="group" required>
                <option value="">Selecione</option>
                <option value="devs">DEV</option>
                <option value="cordenacao">COORDENAÇÃO</option>
                <option value="STAFF">STAFF</option>
                <option value="aluno(a)">ALUNO(A)</option>
                <option value="professor(a)">PROFESSOR(A)</option>
                <option value="responsavel">RESPONSÁVEL</option>
            </select>
        </div>
        <div id="responsavel-fields" style="display: none;">
            <label for="first_name">Nome do responsável:</label>
            <input type="text" id="first_name" name="first_name">
            <label for="last_name">Sobrenome do responsável:</label>
            <input type="text" id="last_name" name="last_name">
            <label for="phone_number">Nº do celular (--):</label>
            <input type="text" id="phone_number" name="phone_number">
            <label for="email">Email do responsável:</label>
            <input type="email" id="email" name="email">
            <label for="address">Endereço do responsável:</label>
            <input type="text" id="address" name="address">
            <label for="cpf">CPF do responsável:</label>
            <input type="text" id="cpf" name="cpf">
            <label for="birthday">Birthday:</label>
            <input type="date" id="birthday" name="birthday">
            <label for="alunos">Alunos do Responsável:</label>
            <select id="alunos" name="alunos" multiple>
                <!-- Options will be dynamically populated -->
            </select>
        </div>
        <button type="submit">Cadastrar</button>
    </form>
    <p>Já tem uma conta? <a href="/login/">Faça login aqui</a>.</p>

    <script>
        document.getElementById('group').addEventListener('change', async (event) => {
            const responsavelFields = document.getElementById('responsavel-fields');
            if (event.target.value === 'responsavel') {
                responsavelFields.style.display = 'block';
                try {
                    const response = await fetch('/api/alunos/');
                    if (response.ok) {
                        const alunos = await response.json();
                        const alunosSelect = document.getElementById('alunos');
                        alunosSelect.innerHTML = '';
                        alunos.forEach(aluno => {
                            const option = document.createElement('option');
                            option.value = aluno.registration_number;
                            option.textContent = aluno.full_name;
                            alunosSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Erro ao carregar alunos:', error);
                }
            } else {
                responsavelFields.style.display = 'none';
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const group = document.getElementById('group').value;
            const formData = {
                username: document.getElementById('username')?.value,
                email: document.getElementById('email')?.value,
                password: document.getElementById('password')?.value,
                group
            };

            if (group === 'responsavel') {
                formData.first_name = document.getElementById('first_name').value;
                formData.last_name = document.getElementById('last_name').value;
                formData.phone_number = document.getElementById('phone_number').value;
                formData.address = document.getElementById('address').value;
                formData.cpf = document.getElementById('cpf').value;
                formData.birthday = document.getElementById('birthday').value;
                formData.alunos = Array.from(document.getElementById('alunos').selectedOptions).map(option => option.value);
            }

            try {
                const response = await fetch('/api/register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Usuário cadastrado com sucesso! Redirecionando para o login.');
                    window.location.href = '/login/';
                } else {
                    alert('Erro no cadastro: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Ocorreu um erro ao tentar cadastrar o usuário.');
            }
        });
    </script>
</body>
</html>
